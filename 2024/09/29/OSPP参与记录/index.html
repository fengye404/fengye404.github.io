<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>OSPP参与记录 | fengye's blog</title><meta name="author" content="风业"><meta name="copyright" content="风业"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前言今年毕业前申请参与了2024年的开源之夏（OSPP），是一次很宝贵的开源项目经验，最终成功结项。写这篇博客以此记录留存。 本博客记录的内容截至日期为 2024:09:30，最终方案相比本文有变动，例如放弃 jprotobuf 方案、重构 Grpc 调用模块等。具体详见：https:&#x2F;&#x2F;github.com&#x2F;alibaba&#x2F;arthas&#x2F;pull&#x2F;2914  项目申请书项目名称：探索 Java">
<meta property="og:type" content="article">
<meta property="og:title" content="OSPP参与记录">
<meta property="og:url" content="https://fengye404.top/2024/09/29/OSPP%E5%8F%82%E4%B8%8E%E8%AE%B0%E5%BD%95/index.html">
<meta property="og:site_name" content="fengye&#39;s blog">
<meta property="og:description" content="前言今年毕业前申请参与了2024年的开源之夏（OSPP），是一次很宝贵的开源项目经验，最终成功结项。写这篇博客以此记录留存。 本博客记录的内容截至日期为 2024:09:30，最终方案相比本文有变动，例如放弃 jprotobuf 方案、重构 Grpc 调用模块等。具体详见：https:&#x2F;&#x2F;github.com&#x2F;alibaba&#x2F;arthas&#x2F;pull&#x2F;2914  项目申请书项目名称：探索 Java">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://q1.qlogo.cn/g?b=qq&nk=1129126684&s=640">
<meta property="article:published_time" content="2024-09-29T07:58:07.000Z">
<meta property="article:modified_time" content="2024-12-31T08:44:08.884Z">
<meta property="article:author" content="风业">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://q1.qlogo.cn/g?b=qq&nk=1129126684&s=640"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://fengye404.top/2024/09/29/OSPP%E5%8F%82%E4%B8%8E%E8%AE%B0%E5%BD%95/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"No results found for: ${query}","hits_stats":"${hits} articles found"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":true,"highlightMacStyle":true},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'OSPP参与记录',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg" style="background-image: url(/img/background.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://q1.qlogo.cn/g?b=qq&amp;nk=1129126684&amp;s=640" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">27</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">fengye's blog</span></a><a class="nav-page-title" href="/"><span class="site-name">OSPP参与记录</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">OSPP参与记录</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-09-29T07:58:07.000Z" title="Created 2024-09-29 15:58:07">2024-09-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-12-31T08:44:08.884Z" title="Updated 2024-12-31 16:44:08">2024-12-31</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">5k</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:720,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2024-12-31 16:44:08&quot;}" hidden></div><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>今年毕业前申请参与了2024年的开源之夏（OSPP），是一次很宝贵的开源项目经验，最终成功结项。写这篇博客以此记录留存。</p>
<p>本博客记录的内容截至日期为 2024:09:30，最终方案相比本文有变动，例如放弃 jprotobuf 方案、重构 Grpc 调用模块等。具体详见：<a target="_blank" rel="noopener" href="https://github.com/alibaba/arthas/pull/2914">https://github.com/alibaba/arthas/pull/2914</a></p>
<hr>
<h1 id="项目申请书"><a href="#项目申请书" class="headerlink" title="项目申请书"></a>项目申请书</h1><center>项目名称：探索 Java 低资源消耗的 gRPC 实现</center>

<center>项目主导师：断岭</center>

<center>申请人：风业</center>

<center>日期：2024.06.03</center>

<center>邮箱：1129126684@qq.com</center>

<hr>
<h2 id="项目背景"><a href="#项目背景" class="headerlink" title="项目背景"></a>项目背景</h2><p>Arthas 是一个 Java 诊断工具，它允许开发人员在无需修改应用程序代码的情况下，动态地监视和解决生产环境中 Java 应用程序的问题。目前 Arthas 主要是通过交互式的命令行提供服务，此外也提供了 http api。但是 http api 比较简陋，预期通过grpc server提供服务。但是官方的 grpc 实现依赖多、运行时内存占用高，本项目旨在提供一种低资源消耗的 grpc 实现，需要支持 stream 并尽量减少外部依赖。</p>
<h2 id="项目主要内容"><a href="#项目主要内容" class="headerlink" title="项目主要内容"></a>项目主要内容</h2><ol>
<li>实现低资源消耗的 grpc 协议，需要尽量减少外部依赖，并支持双向 stream。</li>
<li>基于上述 grpc 协议，提供一个简单的Arthas服务的实现，比如查看Jvm System Properties。</li>
<li>实现 protobuf 的编译代码生成器，优先级不高，先用官方的生成代码也可以接受。</li>
</ol>
<h2 id="项目相关文档"><a href="#项目相关文档" class="headerlink" title="项目相关文档"></a>项目相关文档</h2><ul>
<li>github issue地址：<a target="_blank" rel="noopener" href="https://github.com/alibaba/arthas/issues/2349">https://github.com/alibaba/arthas/issues/2349</a></li>
<li>arthas 官方文档：<a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc">https://arthas.aliyun.com/doc</a></li>
</ul>
<p>其他开源 grpc 实现参考：</p>
<ul>
<li>dubbo 的 triple 实现：<a target="_blank" rel="noopener" href="https://github.com/apache/dubbo/tree/3.2/dubbo-rpc/dubbo-rpc-triple">https://github.com/apache/dubbo/tree/3.2/dubbo-rpc/dubbo-rpc-triple</a></li>
<li>armeria 的 grpc 实现：<a target="_blank" rel="noopener" href="https://armeria.dev/docs/server-grpc">https://armeria.dev/docs/server-grpc</a></li>
<li>wire 的 grpc 实现：<a target="_blank" rel="noopener" href="https://github.com/square/wire">https://github.com/square/wire</a></li>
</ul>
<hr>
<h2 id="项目方案概述"><a href="#项目方案概述" class="headerlink" title="项目方案概述"></a>项目方案概述</h2><p>参考各开源项目的 grpc 实现后，本项目方案设计如下：</p>
<ol>
<li>服务端和客户端使用 protobuf 作为IDL</li>
<li>客户端实现可以由用户自行决定，只要符合官方 grpc 协议即可，例如可以参考 grpc-java 官方的 client 请求实例</li>
<li>服务端不依赖 netty java 的官方实现（即 grpc-netty），因此需要实现两个部分<ol>
<li>stub 接口代码生成：参考 wire，读取 protobuf 后手动实现（可选，前期可以先手动写服务端的 stub 接口）</li>
<li>grpc 实现：参考 grpc-netty 官方实现，主要涉及对 http2 frame 的操作</li>
</ol>
</li>
</ol>
<h3 id="stub-代码生成"><a href="#stub-代码生成" class="headerlink" title="stub 代码生成"></a>stub 代码生成</h3><p>此操作在编译期完成，预计需要在编译期依赖 wire 读取 protobuf schema，然后手动拼接文件。</p>
<p>参考 opentelemetry-java 中关于生成 stub 接口代码的实现：<a target="_blank" rel="noopener" href="https://github.com/open-telemetry/opentelemetry-java/blob/v1.22.0/buildSrc/src/main/kotlin/io/opentelemetry/gradle/ProtoFieldsWireHandler.kt">https://github.com/open-telemetry/opentelemetry-java/blob/v1.22.0/buildSrc/src/main/kotlin/io/opentelemetry/gradle/ProtoFieldsWireHandler.kt</a></p>
<p>可以使用 maven-compiler-plugin 来指定 maven 编译期间执行上述生成过程。</p>
<h3 id="gprc-实现"><a href="#gprc-实现" class="headerlink" title="gprc  实现"></a>gprc  实现</h3><p>grpc 的实现参考 grpc-netty 的实现。grpc 本质上是 http2。</p>
<p><img src="/2021/04/20/MySQL%E5%9F%BA%E7%A1%80/9895e16be720641411c9b27b46276724.png" alt="img"></p>
<p>要实现 grpc，就需要实现 netty 中处理 http2 请求的一些组件：</p>
<ul>
<li><strong>Http2ConnectionDecoder</strong>：<ul>
<li>负责解析 HTTP&#x2F;2 帧，并将它们转换为 gRPC 消息。</li>
<li>通常位于 Netty 的 <code>ChannelPipeline</code> 中，用于处理接收到的 HTTP&#x2F;2 帧。</li>
</ul>
</li>
<li><strong>Http2ConnectionHandler</strong>：<ul>
<li>负责处理 gRPC 消息，包括序列化和反序列化。</li>
<li>通常位于 Netty 的 <code>ChannelPipeline</code> 中，用于处理 gRPC 消息。</li>
</ul>
</li>
<li><strong>Http2ConnectionListener</strong>：<ul>
<li>负责处理 HTTP&#x2F;2 连接的生命周期事件，如设置和更改流状态。</li>
<li>通常位于 Netty 的 <code>ChannelPipeline</code> 中，用于处理 HTTP&#x2F;2 连接的状态变化。</li>
</ul>
</li>
</ul>
<p>参考 grpc-netty 的实现，其中就实现了这些组件。</p>
<p>以读取 data frame 为例，grpc-netty 中通过 io.grpc.netty.NettyServerHandler.FrameListener 实现了 io.netty.handler.codec.http2.Http2FrameAdapter，其中的 onDataRead 方法就会在读取 data frame 时触发，其简略代码如下：</p>
<p>io.grpc.netty.NettyServerHandler#onDataRead</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">onDataRead</span><span class="params">(<span class="type">int</span> streamId, ByteBuf data, <span class="type">int</span> padding, <span class="type">boolean</span> endOfStream)</span></span><br><span class="line">    <span class="keyword">throws</span> Http2Exception &#123;</span><br><span class="line">    ...</span><br><span class="line">    flowControlPing().onDataRead(data.readableBytes(), padding);</span><br><span class="line">    NettyServerStream.<span class="type">TransportState</span> <span class="variable">stream</span> <span class="operator">=</span> serverStream(requireHttp2Stream(streamId));</span><br><span class="line">    stream.inboundDataReceived(data, endOfStream);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>io.grpc.internal.AbstractServerStream.TransportState#inboundDataReceived</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">inboundDataReceived</span><span class="params">(ReadableBuffer frame, <span class="type">boolean</span> endOfStream)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    deframe(frame);</span><br><span class="line">    <span class="keyword">if</span> (endOfStream) &#123;</span><br><span class="line">        <span class="built_in">this</span>.endOfStream = <span class="literal">true</span>;</span><br><span class="line">        closeDeframer(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>io.grpc.internal.AbstractStream.TransportState#deframe</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">deframe</span><span class="params">(<span class="keyword">final</span> ReadableBuffer frame)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        deframer.deframe(frame);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        deframeFailed(t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>io.grpc.internal.MessageDeframer#deframe</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deframe</span><span class="params">(ReadableBuffer data)</span> &#123;</span><br><span class="line">	...</span><br><span class="line">    deliver();</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>io.grpc.internal.MessageDeframer#deliver</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">deliver</span><span class="params">()</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">while</span> (!stopDelivery &amp;&amp; pendingDeliveries &gt; <span class="number">0</span> &amp;&amp; readRequiredBytes()) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">            <span class="keyword">case</span> BODY:</span><br><span class="line">                processBody();</span><br><span class="line">                pendingDeliveries--;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>io.grpc.internal.MessageDeframer#processBody</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processBody</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// There is no reliable way to get the uncompressed size per message when it&#x27;s compressed,</span></span><br><span class="line">    <span class="comment">// because the uncompressed bytes are provided through an InputStream whose total size is</span></span><br><span class="line">    <span class="comment">// unknown until all bytes are read, and we don&#x27;t know when it happens.</span></span><br><span class="line">    statsTraceCtx.inboundMessageRead(currentMessageSeqNo, inboundBodyWireSize, -<span class="number">1</span>);</span><br><span class="line">    inboundBodyWireSize = <span class="number">0</span>;</span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">stream</span> <span class="operator">=</span> compressedFlag ? getCompressedBody() : getUncompressedBody();</span><br><span class="line">    nextFrame = <span class="literal">null</span>;</span><br><span class="line">    listener.messagesAvailable(<span class="keyword">new</span> <span class="title class_">SingleMessageProducer</span>(stream));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Done with this frame, begin processing the next header.</span></span><br><span class="line">    state = State.HEADER;</span><br><span class="line">    requiredLength = HEADER_LENGTH;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当接收到 data frame 后，grpc 的处理方式是将其放入缓冲区中，最终 data frame 结束后，会调用 <code>processBody()</code> 处理 body：从缓冲区中读出 inputStream，然后触发消息。</p>
<p>对 http2 frame 的操作可以参考 grpc-netty 实现，本方案主要修改点在于 processBody，需要替换为针对 stub 生成代码的实现，预计会考虑反射调用的处理。</p>
<p>此外，对于 http2 frame 的操作，netty 还给出了更好的方式，后续可以考虑：<a target="_blank" rel="noopener" href="https://netty.io/4.1/api/io/netty/handler/codec/http2/Http2FrameCodecBuilder.html">Http2FrameCodecBuilder (Netty API Reference (4.1.110.Final))</a></p>
<h2 id="规划"><a href="#规划" class="headerlink" title="规划"></a>规划</h2><ul>
<li><strong>阶段一：研究 netty 实现 grpc 协议（7.1 - 8.15）</strong><ul>
<li>第一周：阅读 grpc-netty 源码，了解 netty 对于 http2 的封装。</li>
<li>第二周、第三周：使用 netty 实现 grpc 协议一元调用。</li>
<li>第四周：继续参考 grpc-netty 源码，了解双向流、异常处理的实现。</li>
<li>第五周、第六周：完成 grpc 双向流的实现。</li>
</ul>
</li>
<li><strong>阶段二：研究 stub 代码生成部分（8.15 - 8.30）</strong><ul>
<li>第一周：阅读 opentelemetry-java 相关实现，了解 protobuf 的 schema、了解 java 代码生成。</li>
<li>第二周：实现 stub 代码生成。</li>
</ul>
</li>
<li><strong>阶段三：使用 grpc 实现 arthas 中的部分功能（9.1 - 9.15）</strong><ul>
<li>第一周：阅读 arthas 的相关源码，了解其实现。</li>
<li>第二周：利用 gprc 实现其中的部分功能。</li>
</ul>
</li>
<li><strong>阶段四：完成结项报告和 pr&#x2F;mr 提交（9.16 - 9.30）</strong><ul>
<li>第一周：为项目编写 readme 文档，便于后续维护修改。</li>
<li>第二周：完成结项报告和 pr&#x2F;mr 提交。</li>
</ul>
</li>
</ul>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>这是我第一次参与到大型的开源项目中来，感谢 ospp 提供了这个机会，十分期待能够给开源社区提供贡献，并积累相关经验，学习更多知识。另外我对 arthas 非常感兴趣，平时的日常开发中也经常使用，如果以后有机会，希望能够继续投入到开源社区的工作中，为开源社区做贡献。</p>
<h1 id="结项报告"><a href="#结项报告" class="headerlink" title="结项报告"></a>结项报告</h1><h2 id="项目信息"><a href="#项目信息" class="headerlink" title="项目信息"></a>项目信息</h2><h3 id="项目介绍"><a href="#项目介绍" class="headerlink" title="项目介绍"></a>项目介绍</h3><p>Arthas 是一个 Java 诊断工具，它允许开发人员在无需修改应用程序代码的情况下，动态地监视和解决生产环境中 Java 应用程序的问题。目前 Arthas 主要是通过交互式的命令行提供服务，此外也提供了 http api。但是 http api 比较简陋，预期通过grpc server提供服务。但是官方的 grpc 实现依赖多、运行时内存占用高，本项目旨在提供一种低资源消耗的 grpc 实现，需要支持 stream 并尽量减少外部依赖。</p>
<p>本项目主要完成了以下内容</p>
<ol>
<li>实现低资源消耗的 grpc 协议，需要尽量减少外部依赖，并支持双向 stream。</li>
<li>实现 protobuf 的序列化和反序列化</li>
</ol>
<h3 id="方案描述"><a href="#方案描述" class="headerlink" title="方案描述"></a>方案描述</h3><p>参考各开源项目的 grpc 实现后，本项目方案设计如下：</p>
<ol>
<li>服务端和客户端使用 protobuf 作为 IDL</li>
<li>客户端实现可以由用户自行决定，只要符合官方 grpc 协议即可，例如可以参考 grpc-java 官方的 client 请求实例</li>
<li>服务端不依赖 netty java 的官方实现（即 grpc-netty），因此需要实现两个部分<ol>
<li>protobuf 的序列化和反序列化，参考 protobuf</li>
<li>grpc 的请求处理，包括一元请求和双向流请求，参考 grpc-netty</li>
</ol>
</li>
</ol>
<h3 id="时间规划"><a href="#时间规划" class="headerlink" title="时间规划"></a>时间规划</h3><ul>
<li><strong>阶段一：研究 netty 实现 grpc 协议（7.1 - 8.15）</strong><ul>
<li>第一周：阅读 grpc-netty 源码，了解 netty 对于 http2 的封装。</li>
<li>第二周、第三周：使用 netty 实现 grpc 协议一元调用。</li>
<li>第四周：继续参考 grpc-netty 源码，了解双向流、异常处理的实现。</li>
<li>第五周、第六周：完成 grpc 双向流的实现。</li>
</ul>
</li>
<li><strong>阶段二：研究 stub 代码生成部分（8.15 - 8.30）</strong><ul>
<li>第一周：阅读 opentelemetry-java 相关实现，了解 protobuf 的 schema、了解 java 代码生成。</li>
<li>第二周：实现 stub 代码生成。</li>
</ul>
</li>
<li><strong>阶段三：使用 grpc 实现 arthas 中的部分功能（9.1 - 9.15）</strong><ul>
<li>第一周：阅读 arthas 的相关源码，了解其实现。</li>
<li>第二周：利用 gprc 实现其中的部分功能。</li>
</ul>
</li>
<li><strong>阶段四：完成结项报告和 pr&#x2F;mr 提交（9.16 - 9.30）</strong><ul>
<li>第一周：为项目编写 readme 文档，便于后续维护修改。</li>
<li>第二周：完成结项报告和 pr&#x2F;mr 提交。</li>
</ul>
</li>
</ul>
<h2 id="项目进度"><a href="#项目进度" class="headerlink" title="项目进度"></a>项目进度</h2><h3 id="已完成工作"><a href="#已完成工作" class="headerlink" title="已完成工作"></a>已完成工作</h3><p>截至930，该项目已完成：</p>
<ol>
<li>protobuf 的序列化和反序列化实现及其单元测试</li>
<li>解析 grpc 协议格式</li>
<li>netty 实现 grpc 的一元请求和流失请求处理</li>
</ol>
<p>本项目未使用除 protobuf 以外的任何外部依赖</p>
<h3 id="实现记录"><a href="#实现记录" class="headerlink" title="实现记录"></a>实现记录</h3><h4 id="protobuf-序列化"><a href="#protobuf-序列化" class="headerlink" title="protobuf 序列化"></a>protobuf 序列化</h4><p>实现 protobuf 的序列化和反序列化大致有两种思路</p>
<ol>
<li>参考 java grpc maven plugin，将解析逻辑实现在生成的 stub 中</li>
<li>参考 jprotobuf，将解析逻辑实现在运行时</li>
</ol>
<p>从本质上来看两种实现方式，其实都是建立 protobuf 字段类型到 java 字段类型的映射，然后处理映射逻辑实现序列化。但是两者实现的方式却不同，【1】是读取 protobuf，在编译期生成 java 代码，java 代码中实现 protobuf 的序列化和反序列化；【2】是根据定义的 java 对象，通过对对象的代理中的逻辑实现 protobuf 序列化和反序列化。</p>
<p>这两种方式各有优劣：</p>
<ol>
<li>逻辑上更符合直觉，但是有两个问题：【1】需要读取 protobuf 定义文件并解析其内容，这方面的库较少，可能需要手动解析；【2】需要处理编译期操作</li>
<li>类似于 “先射箭后画靶”，需要人工从已知的 protobuf 定义文件中解析内容，然后编写 java 类</li>
</ol>
<p>最终采用了方案2，因为成本更低，且有开源库 jprotobuf 参考。</p>
<p><strong>实现原理</strong></p>
<ul>
<li><p>定义 protobuf 到 java 字段类型的映射关系</p>
</li>
<li><p>定义代理类模板</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">$&#123;package&#125;</span><br><span class="line"></span><br><span class="line">import java.io.Serializable;</span><br><span class="line"><span class="comment">&lt;!-- $BeginBlock imports --&gt;</span></span><br><span class="line">import $&#123;importBlock&#125;;</span><br><span class="line"><span class="comment">&lt;!-- $EndBlock imports --&gt;</span></span><br><span class="line"></span><br><span class="line">public class $&#123;className&#125; implements $&#123;codecClassName&#125;&lt;$&#123;targetProxyClassName&#125;&gt;, Serializable &#123;</span><br><span class="line">	public static final long serialVersionUID = 1L;</span><br><span class="line"></span><br><span class="line">    public byte[] encode($&#123;targetProxyClassName&#125; target) throws IOException &#123;</span><br><span class="line">        CodedOutputStreamCache outputCache = CodedOutputStreamCache.get();</span><br><span class="line">        doWriteTo(target, outputCache.getCodedOutputStream());</span><br><span class="line">        return outputCache.getData();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void doWriteTo($&#123;targetProxyClassName&#125; target, CodedOutputStream output)</span><br><span class="line">            throws IOException &#123;</span><br><span class="line">        <span class="comment">&lt;!-- $BeginBlock encodeFields --&gt;</span></span><br><span class="line">        $&#123;dynamicFieldType&#125; $&#123;dynamicFieldName&#125; = null;</span><br><span class="line">        if (!ProtoBufUtil.isNull($&#123;dynamicFieldGetter&#125;)) &#123;</span><br><span class="line">            $&#123;dynamicFieldName&#125; = $&#123;dynamicFieldGetter&#125;;</span><br><span class="line">            $&#123;encodeWriteFieldValue&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">&lt;!-- $EndBlock encodeFields --&gt;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public $&#123;targetProxyClassName&#125; decode(byte[] bb) throws IOException &#123;</span><br><span class="line">        CodedInputStream input = CodedInputStream.newInstance(bb, 0, bb.length);</span><br><span class="line">        return readFrom(input);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int size($&#123;targetProxyClassName&#125; target) throws IOException &#123;</span><br><span class="line">        int size = 0;</span><br><span class="line">        <span class="comment">&lt;!-- $BeginBlock encodeFields --&gt;</span></span><br><span class="line">        $&#123;dynamicFieldType&#125; $&#123;dynamicFieldName&#125; = null;</span><br><span class="line">        if (!ProtoBufUtil.isNull($&#123;dynamicFieldGetter&#125;)) &#123;</span><br><span class="line">            $&#123;dynamicFieldName&#125; = $&#123;dynamicFieldGetter&#125;;</span><br><span class="line">            size += $&#123;sizeDynamicString&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">&lt;!-- $EndBlock encodeFields --&gt;</span></span><br><span class="line">        return size;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public $&#123;targetProxyClassName&#125; readFrom(CodedInputStream input) throws IOException &#123;</span><br><span class="line">        $&#123;targetProxyClassName&#125; target = new $&#123;targetProxyClassName&#125;();</span><br><span class="line">        </span><br><span class="line">        $&#123;initListMapFields&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- $BeginBlock enumFields --&gt;</span></span><br><span class="line">        $&#123;enumInitialize&#125;;</span><br><span class="line">        <span class="comment">&lt;!-- $EndBlock enumFields --&gt;</span></span><br><span class="line">        try &#123;</span><br><span class="line">            boolean done = false;</span><br><span class="line">            ProtobufCodec codec = null;</span><br><span class="line">            while (!done) &#123;</span><br><span class="line">                int tag = input.readTag();</span><br><span class="line">                if (tag == 0) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">&lt;!-- $BeginBlock decodeFields --&gt;</span></span><br><span class="line">                if (tag == $&#123;decodeOrder&#125;) &#123;</span><br><span class="line">                    $&#123;objectDecodeExpress&#125;</span><br><span class="line">                    $&#123;decodeFieldSetValue&#125;</span><br><span class="line">                    $&#123;objectDecodeExpressSuffix&#125;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                $&#123;objectPackedDecodeExpress&#125;</span><br><span class="line">                <span class="comment">&lt;!-- $EndBlock decodeFields --&gt;</span>               </span><br><span class="line">                </span><br><span class="line">                input.skipField(tag);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (com.google.protobuf.InvalidProtocolBufferException e) &#123;</span><br><span class="line">            throw e;</span><br><span class="line">        &#125; catch (java.io.IOException e) &#123;</span><br><span class="line">            throw e;</span><br><span class="line">        &#125;</span><br><span class="line">        return target;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据 protobuf 手动编写对应的 java 类</p>
</li>
<li><p>运行时为指定的类实现代理，通过开源库 MiniTemplator 解析并填充内容</p>
</li>
</ul>
<h4 id="http2-格式解析"><a href="#http2-格式解析" class="headerlink" title="http2 格式解析"></a>http2 格式解析</h4><p>grpc 是基于 netty 的，想要实现 grpc 协议，就必须要先解析 http2 协议格式。</p>
<p>netty 中提供了非常简单的操作 http2 frame 的方式：<a target="_blank" rel="noopener" href="https://netty.io/4.1/api/io/netty/handler/codec/http2/Http2FrameCodecBuilder.html">Http2FrameCodecBuilder (Netty API Reference (4.1.110.Final))</a>。</p>
<p>代码实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Http2Handler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;Http2Frame&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="built_in">super</span>.channelRead(ctx, msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, Http2Frame frame)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (frame <span class="keyword">instanceof</span> Http2HeadersFrame) &#123;</span><br><span class="line">            handleGrpcRequest((Http2HeadersFrame) frame, ctx);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (frame <span class="keyword">instanceof</span> Http2DataFrame) &#123;</span><br><span class="line">            handleGrpcData((Http2DataFrame) frame, ctx);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> &#123;</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>channelRead0</code> 中，netty 用 Http2Frame 封装了 http2 的 frame，简化了 http2 frame 的解析操作。</p>
<h4 id="grpc-请求解析"><a href="#grpc-请求解析" class="headerlink" title="grpc 请求解析"></a>grpc 请求解析</h4><p>接收到了 http2Frame 后，需要将其解析为 grpc 请求。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/grpc/grpc/blob/master/doc/PROTOCOL-HTTP2.md">https://github.com/grpc/grpc/blob/master/doc/PROTOCOL-HTTP2.md</a> 定义了 http2 中 grpc 协议的一些基本格式</p>
</blockquote>
<p><img src="/2021/04/20/MySQL%E5%9F%BA%E7%A1%80/image-20240929001524840-1735632468022-3.png" alt="image-20240929001524840"></p>
<p>可以看到 grpc 实际上就是在 http2 的 body 中塞入了一些 grpc 包头和业务数据。那么要解析 grpc 协议，实际上只需要解析 http2 协议，在此基础上解析 grpc 包头即可。</p>
<p>代码中将 grpc 请求封装为一个类来处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GrpcRequest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求对应的 streamId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer streamId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求的 service</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String service;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求的 method</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String method;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 二进制数据，可能包含多个 grpc body，每个 body 都带有 5 个 byte 的前缀，分别是 boolean compressed - int length</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> ByteBuf byteData;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 二进制数据的长度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> length;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求class</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; clazz;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否是 grpc 流式请求</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> stream;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否是 grpc 流式请求的第一个data</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> streamFirstData;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GrpcRequest</span><span class="params">(Integer streamId, String path, String method)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.streamId = streamId;</span><br><span class="line">        <span class="built_in">this</span>.service = path;</span><br><span class="line">        <span class="built_in">this</span>.method = method;</span><br><span class="line">        <span class="built_in">this</span>.byteData = ByteUtil.newByteBuf();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeData</span><span class="params">(ByteBuf byteBuf)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = ByteUtil.getBytes(byteBuf);</span><br><span class="line">        <span class="keyword">if</span> (bytes.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">byte</span>[] decompressedData = decompressGzip(bytes);</span><br><span class="line">        <span class="keyword">if</span> (decompressedData == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        byteData.writeBytes(ByteUtil.newByteBuf(decompressedData));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 读取部分数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] readData() &#123;</span><br><span class="line">        <span class="keyword">if</span> (byteData.readableBytes() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">compressed</span> <span class="operator">=</span> byteData.readBoolean();</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> byteData.readInt();</span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[length];</span><br><span class="line">        byteData.readBytes(bytes);</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clearData</span><span class="params">()</span> &#123;</span><br><span class="line">        byteData.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>[] decompressGzip(<span class="type">byte</span>[] compressedData) &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isGzip</span> <span class="operator">=</span> (compressedData.length &gt; <span class="number">2</span> &amp;&amp; (compressedData[<span class="number">0</span>] &amp; <span class="number">0xff</span>) == <span class="number">0x1f</span> &amp;&amp; (compressedData[<span class="number">1</span>] &amp; <span class="number">0xff</span>) == <span class="number">0x8b</span>);</span><br><span class="line">        <span class="keyword">if</span> (isGzip) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">byteStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(compressedData);</span><br><span class="line">                <span class="type">GZIPInputStream</span> <span class="variable">gzipStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GZIPInputStream</span>(byteStream);</span><br><span class="line">                <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                <span class="type">int</span> len;</span><br><span class="line">                <span class="type">ByteArrayOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">                <span class="keyword">while</span> ((len = gzipStream.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    out.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> out.toByteArray();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                System.err.println(<span class="string">&quot;Failed to decompress GZIP data: &quot;</span> + e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> compressedData;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ByteBuf <span class="title function_">decompressGzip</span><span class="params">(ByteBuf byteBuf)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] compressedData = ByteUtil.getBytes(byteBuf);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isGzip</span> <span class="operator">=</span> (compressedData.length &gt; <span class="number">2</span> &amp;&amp; (compressedData[<span class="number">0</span>] &amp; <span class="number">0xff</span>) == <span class="number">0x1f</span> &amp;&amp; (compressedData[<span class="number">1</span>] &amp; <span class="number">0xff</span>) == <span class="number">0x8b</span>);</span><br><span class="line">        <span class="keyword">if</span> (isGzip) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">byteStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(compressedData);</span><br><span class="line">                <span class="type">GZIPInputStream</span> <span class="variable">gzipStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GZIPInputStream</span>(byteStream);</span><br><span class="line">                <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                <span class="type">int</span> len;</span><br><span class="line">                <span class="type">ByteArrayOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">                <span class="keyword">while</span> ((len = gzipStream.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    out.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> ByteUtil.newByteBuf(out.toByteArray());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                System.err.println(<span class="string">&quot;Failed to decompress GZIP data: &quot;</span> + e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> byteBuf;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="grpc-请求路由调用"><a href="#grpc-请求路由调用" class="headerlink" title="grpc 请求路由调用"></a>grpc 请求路由调用</h4><p>将 grpc 数据读取出来后，配合前面的 protobuf 序列化部分，就可以将请求数据转化为具体的请求对象。</p>
<p>获取到请求对象后，需要将请求路由到具体的调用方法。</p>
<p>在一次请求的 http2 header frame 中，用 <code>:path</code> header 值存储了调用的路径，通过路径即可调用到具体的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GrpcDispatcher</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">GRPC_SERVICE_PACKAGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;com.taobao.arthas.grpc.server.service.impl&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, MethodHandle&gt; grpcMethodInvokeMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Boolean&gt; grpcMethodStreamMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">loadGrpcService</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Class&lt;?&gt;&gt; classes = ReflectUtil.findClasses(GRPC_SERVICE_PACKAGE_NAME);</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; clazz : classes) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.isAnnotationPresent(GrpcService.class)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 处理 service</span></span><br><span class="line">                    <span class="type">GrpcService</span> <span class="variable">grpcService</span> <span class="operator">=</span> clazz.getAnnotation(GrpcService.class);</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> clazz.getDeclaredConstructor().newInstance();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 处理 method</span></span><br><span class="line">                    MethodHandles.<span class="type">Lookup</span> <span class="variable">lookup</span> <span class="operator">=</span> MethodHandles.lookup();</span><br><span class="line">                    Method[] declaredMethods = clazz.getDeclaredMethods();</span><br><span class="line">                    <span class="keyword">for</span> (Method method : declaredMethods) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (method.isAnnotationPresent(GrpcMethod.class)) &#123;</span><br><span class="line">                            <span class="type">GrpcMethod</span> <span class="variable">grpcMethod</span> <span class="operator">=</span> method.getAnnotation(GrpcMethod.class);</span><br><span class="line">                            <span class="type">MethodHandle</span> <span class="variable">methodHandle</span> <span class="operator">=</span> lookup.unreflect(method);</span><br><span class="line">                            <span class="type">String</span> <span class="variable">grpcMethodKey</span> <span class="operator">=</span> generateGrpcMethodKey(grpcService.value(), grpcMethod.value());</span><br><span class="line">                            grpcMethodInvokeMap.put(grpcMethodKey, methodHandle.bindTo(instance));</span><br><span class="line">                            grpcMethodStreamMap.put(grpcMethodKey, grpcMethod.stream());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">generateGrpcMethodKey</span><span class="params">(String serviceName, String methodName)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> serviceName + <span class="string">&quot;.&quot;</span> + methodName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GrpcResponse <span class="title function_">execute</span><span class="params">(String serviceName, String methodName, Object arg)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">MethodHandle</span> <span class="variable">methodHandle</span> <span class="operator">=</span> grpcMethodInvokeMap.get(generateGrpcMethodKey(serviceName, methodName));</span><br><span class="line">        <span class="type">MethodType</span> <span class="variable">type</span> <span class="operator">=</span> grpcMethodInvokeMap.get(generateGrpcMethodKey(serviceName, methodName)).type();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">execute</span> <span class="operator">=</span> methodHandle.invoke(arg);</span><br><span class="line">        <span class="type">GrpcResponse</span> <span class="variable">grpcResponse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GrpcResponse</span>();</span><br><span class="line">        grpcResponse.setClazz(type.returnType());</span><br><span class="line">        grpcResponse.writeResponseData(execute);</span><br><span class="line">        <span class="keyword">return</span> grpcResponse;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GrpcResponse <span class="title function_">execute</span><span class="params">(GrpcRequest request)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">service</span> <span class="operator">=</span> request.getService();</span><br><span class="line">        <span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> request.getMethod();</span><br><span class="line">        <span class="comment">// protobuf 规范只能有单入参</span></span><br><span class="line">        request.setClazz(getRequestClass(request.getService(), request.getMethod()));</span><br><span class="line">        <span class="type">ProtobufCodec</span> <span class="variable">protobufCodec</span> <span class="operator">=</span> ProtobufProxy.getCodecCacheSide(request.getClazz());</span><br><span class="line">        <span class="type">Object</span> <span class="variable">decode</span> <span class="operator">=</span> protobufCodec.decode(request.readData());</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.execute(service, method, decode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取指定 service method 对应的入参类型</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> serviceName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> methodName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getRequestClass(String serviceName, String methodName) &#123;</span><br><span class="line">        <span class="comment">//protobuf 规范只能有单入参</span></span><br><span class="line">        <span class="keyword">return</span> Optional.ofNullable(grpcMethodInvokeMap.get(generateGrpcMethodKey(serviceName, methodName))).orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;The specified grpc method does not exist&quot;</span>)).type().parameterArray()[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkGrpcStream</span><span class="params">(GrpcRequest request)</span> &#123;</span><br><span class="line">        request.setStream(</span><br><span class="line">                Optional.ofNullable(grpcMethodStreamMap.get(generateGrpcMethodKey(request.getService(), request.getMethod())))</span><br><span class="line">                        .orElse(<span class="literal">false</span>)</span><br><span class="line">        );</span><br><span class="line">        request.setStreamFirstData(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="grpc-请求响应"><a href="#grpc-请求响应" class="headerlink" title="grpc 请求响应"></a>grpc 请求响应</h4><p>处理完请求后，需要将请求响应给客户端，这里可以 wireshark 抓包 http2 frame，观察一次正常的 grpc 请求会包含什么内容。</p>
<p>wireshark 抓包观察：</p>
<p><img src="/2021/04/20/MySQL%E5%9F%BA%E7%A1%80/image-20240818210447615-1735632505978-5.png" alt="image-20240818210447615"></p>
<p><img src="/2021/04/20/MySQL%E5%9F%BA%E7%A1%80/image-20240818210501661-1735632509942-7.png" alt="image-20240818210501661"></p>
<p><img src="/2021/04/20/MySQL%E5%9F%BA%E7%A1%80/image-20240818210514779-1735632517726-9.png" alt="image-20240818210514779"></p>
<p><img src="/2021/04/20/MySQL%E5%9F%BA%E7%A1%80/image-20240818210522123-1735632521652-11.png" alt="image-20240818210522123"></p>
<p><img src="/2021/04/20/MySQL%E5%9F%BA%E7%A1%80/image-20240818210530001-1735632525719-13.png" alt="image-20240818210530001"></p>
<p><img src="/2021/04/20/MySQL%E5%9F%BA%E7%A1%80/image-20240818210549107-1735632529711-15.png" alt="image-20240818210549107"></p>
<p><img src="/2021/04/20/MySQL%E5%9F%BA%E7%A1%80/image-20240818210558027-1735632532683-17.png" alt="image-20240818210558027"></p>
<p>在上图中可以发现一次 grpc 请求的请求响应过程大概如下：</p>
<ol>
<li>客户端向服务端发送 http2 frame，其中附带了一个 header 和一个 data</li>
<li>客户端向服务端发送一个空的 data frame，表示流结束（end stream）</li>
<li>服务端向客户端发送 ping</li>
<li>客户端响应服务端 pong</li>
<li>服务端响应客户端请求，其中附带了一个 heade</li>
<li>服务端响应客户端请求，其中附带了一个 data 和一个 header</li>
<li>客户端发送 RST_STREAM，结束请求</li>
</ol>
<p>其中 34 netty 会自动处理，主要看请求的接受和发送。</p>
<p>client 发送请求时，除了正常的附带数据的 http2 data frame 外，还会附带一个标识流结束的 http2 data frame；server 响应请求时，还会附带两个 header。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleGrpcData</span><span class="params">(Http2DataFrame dataFrame, ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">GrpcRequest</span> <span class="variable">grpcRequest</span> <span class="operator">=</span> dataBuffer.get(dataFrame.stream().id());</span><br><span class="line">    grpcRequest.writeData(dataFrame.content());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (grpcRequest.isStream()) &#123;</span><br><span class="line">        <span class="comment">// 流式调用，即刻响应</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">GrpcResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GrpcResponse</span>();</span><br><span class="line">            <span class="type">byte</span>[] bytes = grpcRequest.readData();</span><br><span class="line">            <span class="keyword">while</span> (bytes != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">ProtobufCodec</span> <span class="variable">protobufCodec</span> <span class="operator">=</span> ProtobufProxy.getCodecCacheSide(grpcDispatcher.getRequestClass(grpcRequest.getService(), grpcRequest.getMethod()));</span><br><span class="line">                <span class="type">Object</span> <span class="variable">decode</span> <span class="operator">=</span> protobufCodec.decode(bytes);</span><br><span class="line">                response = grpcDispatcher.execute(grpcRequest.getService(), grpcRequest.getMethod(), decode);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 针对第一个响应发送 header</span></span><br><span class="line">                <span class="keyword">if</span> (grpcRequest.isStreamFirstData()) &#123;</span><br><span class="line">                    ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">DefaultHttp2HeadersFrame</span>(response.getEndHeader()).stream(dataFrame.stream()));</span><br><span class="line">                    grpcRequest.setStreamFirstData(<span class="literal">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">DefaultHttp2DataFrame</span>(response.getResponseData()).stream(dataFrame.stream()));</span><br><span class="line"></span><br><span class="line">                bytes = grpcRequest.readData();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            grpcRequest.clearData();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (dataFrame.isEndStream()) &#123;</span><br><span class="line">                ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">DefaultHttp2HeadersFrame</span>(response.getEndStreamHeader(), <span class="literal">true</span>).stream(dataFrame.stream()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            processError(ctx, e, dataFrame.stream());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 非流式调用，等到 endStream 再响应</span></span><br><span class="line">        <span class="keyword">if</span> (dataFrame.isEndStream()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">GrpcResponse</span> <span class="variable">response</span> <span class="operator">=</span> grpcDispatcher.execute(grpcRequest);</span><br><span class="line">                ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">DefaultHttp2HeadersFrame</span>(response.getEndHeader()).stream(dataFrame.stream()));</span><br><span class="line">                ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">DefaultHttp2DataFrame</span>(response.getResponseData()).stream(dataFrame.stream()));</span><br><span class="line">                ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">DefaultHttp2HeadersFrame</span>(response.getEndStreamHeader(), <span class="literal">true</span>).stream(dataFrame.stream()));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                processError(ctx, e, dataFrame.stream());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于一元调用，需要在收到 end stream 的 frame 时才响应；对于双向 stream 调用，则每次都需要响应。</p>
<h4 id="结果验证"><a href="#结果验证" class="headerlink" title="结果验证"></a>结果验证</h4><p><img src="/2021/04/20/MySQL%E5%9F%BA%E7%A1%80/a925910e3a991ae54592d2f4c26a7a2.png" alt="a925910e3a991ae54592d2f4c26a7a2"></p>
<p><img src="/2021/04/20/MySQL%E5%9F%BA%E7%A1%80/1128115203a1559176da16aa96e1ce3.png" alt="1128115203a1559176da16aa96e1ce3"></p>
<p>开发完毕后，使用 apifox 针对服务发起调用，验证结果符合预期；</p>
<p>此外也在项目中提供了针对于 protobuf 序列化的单元测试和 grpc 请求的测试方法。经验证，同样符合测试预期。</p>
<h3 id="后续计划"><a href="#后续计划" class="headerlink" title="后续计划"></a>后续计划</h3><ol>
<li>在项目编写过程中主要考虑的问题是去除外部依赖，对于性能优化研究的还不够深入。后续需要继续深入优化性能。</li>
<li>由于时间问题，只是提供了一个实现了 grpc 协议的处理框架，但是并未实现某个具体的 arthas 功能。后续需要继续深入实现 arthas 的功能。</li>
<li>对于某些 grpc 实现细节还没有深入研究，例如 gzip 的解析、http2 协议的升级等等。后续需要继续投入。</li>
</ol>
<h2 id="个人总结"><a href="#个人总结" class="headerlink" title="个人总结"></a>个人总结</h2><p>在这次项目过程中，我深入了解了 HTTP&#x2F;2 和 gRPC 协议，学习了如何使用 Wireshark 抓包以观察二进制数据，同时掌握了 Netty 的编写与使用。此外，在借鉴 jprotobuf 的过程中，我对 Java 编译的相关知识也有了更深刻的认识。在编写 gRPC 调用路由的过程中，我更深入地理解了 Java 的方法句柄及其应用。这是我首次参与大型开源项目，借此机会，我不仅提升了自己的技术能力，也拓宽了视野。衷心感谢 OSPP 提供的这个宝贵机会，让我在实践中受益良多。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://fengye404.top">风业</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://fengye404.top/2024/09/29/OSPP%E5%8F%82%E4%B8%8E%E8%AE%B0%E5%BD%95/">https://fengye404.top/2024/09/29/OSPP参与记录/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="https://q1.qlogo.cn/g?b=qq&amp;nk=1129126684&amp;s=640" data-sites="twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/2023/04/28/%E9%83%A8%E7%BD%B2Grafana-Prometheus-Exporter/" title="部署Grafana+Prometheus+Exporter"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">部署Grafana+Prometheus+Exporter</div></div><div class="info-2"><div class="info-item-1">Grafana1docker run -d --name=grafana --network host grafana/grafana-enterprise  Prometheus下载并解压 123wget https://github.com/prometheus/prometheus/releases/download/v2.42.0/prometheus-2.42.0.linux-amd64.tar.gztar xvfz prometheus-*.tar.gz  给 prometheus 配置 systemd 启动，默认运行端口为 9090 12345678910111213141516171819202122vim /usr/lib/systemd/system/prometheus.service[Unit]Description=prometheus[Service]WorkingDirectory=/home/fengye/prometheus/prometheus-2.42.0.linux-amd64#...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://q1.qlogo.cn/g?b=qq&amp;nk=1129126684&amp;s=640" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">风业</div><div class="author-info-description">fengye's blog</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">27</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/fengye404"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">my new hexo blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%94%B3%E8%AF%B7%E4%B9%A6"><span class="toc-number">2.</span> <span class="toc-text">项目申请书</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E8%83%8C%E6%99%AF"><span class="toc-number">2.1.</span> <span class="toc-text">项目背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E4%B8%BB%E8%A6%81%E5%86%85%E5%AE%B9"><span class="toc-number">2.2.</span> <span class="toc-text">项目主要内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%9B%B8%E5%85%B3%E6%96%87%E6%A1%A3"><span class="toc-number">2.3.</span> <span class="toc-text">项目相关文档</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0"><span class="toc-number">2.4.</span> <span class="toc-text">项目方案概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#stub-%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90"><span class="toc-number">2.4.1.</span> <span class="toc-text">stub 代码生成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gprc-%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.4.2.</span> <span class="toc-text">gprc  实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%84%E5%88%92"><span class="toc-number">2.5.</span> <span class="toc-text">规划</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">2.6.</span> <span class="toc-text">其他</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%93%E9%A1%B9%E6%8A%A5%E5%91%8A"><span class="toc-number">3.</span> <span class="toc-text">结项报告</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E4%BF%A1%E6%81%AF"><span class="toc-number">3.1.</span> <span class="toc-text">项目信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.1.1.</span> <span class="toc-text">项目介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E6%8F%8F%E8%BF%B0"><span class="toc-number">3.1.2.</span> <span class="toc-text">方案描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E8%A7%84%E5%88%92"><span class="toc-number">3.1.3.</span> <span class="toc-text">时间规划</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E8%BF%9B%E5%BA%A6"><span class="toc-number">3.2.</span> <span class="toc-text">项目进度</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%B2%E5%AE%8C%E6%88%90%E5%B7%A5%E4%BD%9C"><span class="toc-number">3.2.1.</span> <span class="toc-text">已完成工作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%AE%B0%E5%BD%95"><span class="toc-number">3.2.2.</span> <span class="toc-text">实现记录</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#protobuf-%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">protobuf 序列化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#http2-%E6%A0%BC%E5%BC%8F%E8%A7%A3%E6%9E%90"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">http2 格式解析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#grpc-%E8%AF%B7%E6%B1%82%E8%A7%A3%E6%9E%90"><span class="toc-number">3.2.2.3.</span> <span class="toc-text">grpc 请求解析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#grpc-%E8%AF%B7%E6%B1%82%E8%B7%AF%E7%94%B1%E8%B0%83%E7%94%A8"><span class="toc-number">3.2.2.4.</span> <span class="toc-text">grpc 请求路由调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#grpc-%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94"><span class="toc-number">3.2.2.5.</span> <span class="toc-text">grpc 请求响应</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E6%9E%9C%E9%AA%8C%E8%AF%81"><span class="toc-number">3.2.2.6.</span> <span class="toc-text">结果验证</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E7%BB%AD%E8%AE%A1%E5%88%92"><span class="toc-number">3.2.3.</span> <span class="toc-text">后续计划</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AA%E4%BA%BA%E6%80%BB%E7%BB%93"><span class="toc-number">3.3.</span> <span class="toc-text">个人总结</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/09/29/OSPP%E5%8F%82%E4%B8%8E%E8%AE%B0%E5%BD%95/" title="OSPP参与记录">OSPP参与记录</a><time datetime="2024-09-29T07:58:07.000Z" title="Created 2024-09-29 15:58:07">2024-09-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/04/28/%E9%83%A8%E7%BD%B2Grafana-Prometheus-Exporter/" title="部署Grafana+Prometheus+Exporter">部署Grafana+Prometheus+Exporter</a><time datetime="2023-04-28T07:50:12.000Z" title="Created 2023-04-28 15:50:12">2023-04-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/01/29/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/" title="类加载机制">类加载机制</a><time datetime="2023-01-29T07:49:36.000Z" title="Created 2023-01-29 15:49:36">2023-01-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/01/24/Redis%E7%AC%94%E8%AE%B0/" title="Redis笔记">Redis笔记</a><time datetime="2023-01-24T07:49:03.000Z" title="Created 2023-01-24 15:49:03">2023-01-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/01/18/%E9%85%8D%E7%BD%AEHTTPS/" title="配置HTTPS">配置HTTPS</a><time datetime="2023-01-18T07:48:21.000Z" title="Created 2023-01-18 15:48:21">2023-01-18</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent;"><div id="footer-wrap"><div class="copyright">&copy;2024 By 风业</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>